#!/usr/bin/env bash

if [[ -f .env ]]; then
  # Mark variables which are modified or created for export
  set -a
  source .env
  set +a
fi

if ! git is-repo; then
  echo "You must run this in a git repo" >&2
  exit 1
fi

if [[ -z "$CIRCLECI_PROJECT_SLUG" ]]; then
  echo "CIRCLECI_PROJECT_SLUG not set" >&2
  exit 1
fi

export circle_token=$(keyring get circleci Circle-Token)
if [[ -z "$circle_token" ]]; then
  echo "Circle-Token not found in keyring" >&2
  echo "Store it by running: 'keyring set circleci Circle-Token'" >&2
  exit 1
fi

export git_revision=$(git rev-parse --verify HEAD)
export git_branch=$(git branch --show-current)

if [[ "$1" == "status" ]]; then
  shift
  circle-status.sh "$@"
else
  circle-logs.sh "$@"
fi
