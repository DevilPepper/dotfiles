#!/usr/bin/env bash

if [ "$#" -ne 2 ]
then
  echo "Usage:"
  echo "generate-gpg-key EMAIL USERNAME"
  exit 1
fi

email=$1
name=$2
# Y_NEXT=$((`date +%Y` + 1))
# DAYS_UNTIL_EXPIRED=$(( (`date -d "2024-01-01" +%s` - `date +%s`) / (60*60*24) ))
DAYS_UNTIL_EXPIRED=0

echo "=================================================================="
echo "You'll be prompted for your user pin first and then your admin pin"
echo "=================================================================="

gpg --card-edit --command-fd 0 << EOF
admin
generate
n
y
$DAYS_UNTIL_EXPIRED
$name
$email

quit
EOF

KEY_ID=$(gpg --list-secret-keys --with-colons | grep sec | tail -1 | cut -d: -f5)
echo "  signingkey = $KEY_ID" >> ~/secret.gitconfig

echo "================================================="
echo "Please remove old key IDs from ~/secret.gitconfig"
echo "================================================="
cat ~/secret.gitconfig

gpg --armor --export $KEY_ID > /tmp/${KEY_ID}.asc
echo "Copy /tmp/${KEY_ID}.asc to all your machines that require it"

# Might fail here if clip alias is not defined
gpg --armor --export $KEY_ID | clip
echo "Public key is in your clipboard!"
